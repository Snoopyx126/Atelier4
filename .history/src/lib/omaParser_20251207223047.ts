import * as THREE from 'three';

export const parseOMA = (omaContent: string): THREE.Shape | null => {
  try {
    const lines = omaContent.split('\n');
    let radii: number[] = [];

    // 1. Extraction des rayons (R=...)
    lines.forEach(line => {
      if (line.startsWith('R=')) {
        const values = line.substring(2).split(';').map(v => parseInt(v.trim(), 10));
        radii = [...radii, ...values];
      }
    });

    // Nettoyage (on enlève les NaN)
    radii = radii.filter(r => !isNaN(r));

    if (radii.length === 0) return null;

    // 2. Conversion Polaire -> Cartésien (x, y)
    // Le format OMA standard a souvent 1000 points pour 360° (ou 2PI)
    const shape = new THREE.Shape();
    const totalPoints = radii.length;
    
    // Facteur d'échelle (OMA est souvent en 1/100mm, on veut des cm ou unités ThreeJS)
    // 2000 => 20mm => 2.0 unités ThreeJS
    const scale = 0.001; 

    for (let i = 0; i < totalPoints; i++) {
      const radius = radii[i] * scale;
      
      // L'angle tourne dans le sens horaire ou anti-horaire selon la machine
      // OMA commence souvent à 0° (Nez ou Tempe)
      const angle = (i / totalPoints) * Math.PI * 2;

      // Conversion
      const x = Math.cos(angle) * radius;
      const y = Math.sin(angle) * radius;

      if (i === 0) {
        shape.moveTo(x, y);
      } else {
        shape.lineTo(x, y);
      }
    }

    shape.closePath();
    return shape;

  } catch (e) {
    console.error("Erreur parsing OMA", e);
    return null;
  }
};

// Données OMA brutes (Cartier 0284O56)
export const CARTIER_OMA = `
R=2706;2711;2715;2720;2725;2729;2734;2738;2743;2748
R=2752;2757;2762;2766;2771;2775;2780;2785;2789;2794
R=2798;2803;2808;2812;2817;2822;2826;2831;2835;2840
R=2845;2849;2854;2858;2863;2867;2872;2877;2881;2886
R=2890;2895;2899;2904;2908;2913;2917;2922;2926;2931
R=2935;2942;2950;2958;2966;2974;2982;2986;2988;2991
R=2994;2997;3000;3003;3006;3009;3013;3016;3017;3017
R=3017;3018;3018;3019;3019;3020;3021;3022;3023;3022
R=3020;3019;3017;3016;3014;3013;3012;3011;3010;3009
R=3005;3000;2994;2989;2985;2980;2975;2971;2966;2962
R=2958;2949;2938;2928;2918;2909;2899;2890;2881;2872
R=2863;2854;2846;2837;2829;2816;2804;2791;2779;2767
R=2755;2744;2733;2721;2711;2700;2689;2679;2668;2655
R=2643;2632;2620;2609;2598;2587;2576;2565;2555;2545
R=2535;2525;2515;2503;2492;2481;2470;2459;2448;2438
R=2428;2418;2408;2398;2389;2379;2370;2361;2352;2344
R=2335;2327;2318;2310;2302;2294;2287;2279;2272;2265
R=2258;2251;2244;2237;2230;2224;2218;2211;2205;2199
R=2193;2188;2182;2177;2171;2166;2161;2156;2151;2146
R=2141;2137;2132;2128;2123;2118;2113;2108;2104;2099
R=2095;2090;2086;2082;2078;2074;2070;2066;2063;2059
R=2056;2052;2049;2046;2043;2040;2037;2034;2031;2028
R=2026;2023;2021;2019;2016;2014;2012;2010;2008;2007
R=2005;2003;2002;2000;1999;1997;1996;1995;1994;1993
R=1992;1991;1990;1990;1989;1988;1988;1988;1987;1987
R=1987;1987;1987;1987;1987;1987;1988;1988;1989;1989
R=1989;1990;1990;1991;1991;1992;1992;1993;1994;1995
R=1996;1997;1998;2000;2001;2002;2004;2005;2007;2009
R=2011;2013;2015;2017;2019;2021;2023;2026;2028;2031
R=2034;2036;2039;2042;2045;2048;2051;2055;2058;2062
R=2065;2069;2073;2076;2080;2083;2086;2089;2093;2096
R=2100;2104;2108;2112;2116;2120;2124;2128;2133;2137
R=2142;2147;2152;2157;2162;2167;2172;2178;2183;2189
R=2195;2201;2207;2213;2219;2225;2232;2239;2245;2252
R=2259;2266;2273;2278;2284;2290;2295;2301;2307;2313
R=2319;2326;2332;2338;2345;2352;2359;2366;2373;2381
R=2388;2396;2404;2412;2420;2428;2436;2445;2454;2462
R=2471;2481;2490;2499;2509;2519;2527;2533;2540;2546
R=2553;2560;2567;2574;2582;2589;2597;2605;2613;2621
R=2629;2637;2642;2646;2651;2655;2660;2664;2669;2674
R=2679;2684;2689;2695;2700;2706;2712;2717;2722;2726
R=2730;2735;2739;2744;2748;2753;2758;2763;2768;2774
R=2779;2785;2791;2796;2801;2805;2809;2814;2819;2824
R=2829;2834;2839;2844;2850;2854;2858;2862;2865;2869
R=2874;2878;2882;2887;2891;2896;2899;2898;2897;2896
R=2895;2895;2894;2894;2893;2893;2893;2893;2890;2886
R=2882;2878;2875;2871;2868;2865;2862;2859;2856;2853
R=2850;2847;2844;2841;2838;2835;2832;2829;2826;2823
R=2820;2818;2815;2813;2811;2809;2807;2805;2803;2801
R=2800;2798;2797;2796;2794;2793;2791;2790;2789;2788
R=2787;2786;2785;2785;2784;2784;2783;2783;2783;2783
R=2783;2783;2784;2783;2784;2784;2784;2785;2785;2786
R=2786;2787;2788;2789;2791;2792;2793;2795;2796;2798
R=2800;2801;2803;2804;2806;2808;2810;2812;2814;2816
R=2818;2821;2823;2826;2829;2832;2835;2838;2841;2842
R=2844;2845;2847;2849;2851;2853;2855;2857;2859;2862
R=2864;2867;2870;2873;2876;2879;2880;2880;2876;2871
R=2867;2863;2859;2855;2852;2848;2845;2841;2838;2835
R=2832;2829;2826;2817;2808;2800;2791;2783;2775;2767
R=2760;2752;2745;2738;2730;2723;2717;2706;2696;2686
R=2676;2666;2657;2647;2638;2629;2620;2611;2603;2594
R=2586;2576;2566;2556;2547;2537;2528;2519;2510;2501
R=2492;2484;2475;2467;2459;2451;2442;2433;2425;2416
R=2408;2399;2391;2383;2375;2368;2360;2353;2345;2338
R=2331;2325;2317;2310;2302;2295;2288;2281;2275;2268
R=2262;2255;2249;2243;2237;2231;2225;2220;2214;2208
R=2202;2196;2190;2184;2178;2173;2167;2162;2157;2152
R=2146;2142;2137;2132;2127;2123;2118;2114;2110;2106
R=2102;2098;2094;2090;2087;2083;2080;2076;2073;2070
R=2067;2064;2061;2058;2056;2053;2050;2048;2046;2043
R=2041;2039;2037;2035;2033;2031;2029;2026;2023;2021
R=2018;2016;2014;2012;2010;2008;2006;2004;2002;2001
R=1999;1997;1996;1995;1993;1992;1991;1990;1989;1988
R=1988;1987;1986;1986;1985;1985;1985;1984;1984;1984
R=1984;1984;1985;1985;1985;1986;1986;1987;1987;1988
R=1989;1990;1991;1992;1993;1994;1995;1996;1996;1997
R=1998;1998;1999;2000;2000;2001;2002;2003;2004;2005
R=2005;2006;2007;2008;2009;2010;2011;2012;2013;2014
R=2015;2016;2018;2019;2020;2021;2022;2024;2025;2026
R=2027;2029;2030;2031;2033;2034;2036;2037;2038;2040
R=2041;2043;2044;2046;2048;2049;2051;2052;2054;2056
R=2058;2059;2061;2063;2065;2066;2068;2070;2072;2074
R=2076;2078;2080;2082;2084;2086;2088;2090;2092;2094
R=2096;2098;2100;2102;2105;2107;2109;2111;2113;2116
R=2118;2120;2123;2125;2128;2130;2132;2135;2137;2140
R=2142;2145;2147;2150;2153;2155;2158;2160;2163;2166
R=2168;2171;2174;2177;2180;2182;2185;2188;2191;2194
R=2197;2200;2202;2205;2208;2211;2214;2217;2221;2224
R=2227;2230;2233;2236;2239;2242;2246;2249;2252;2255
R=2259;2262;2265;2268;2272;2275;2279;2282;2285;2289
R=2292;2296;2299;2303;2306;2310;2313;2317;2320;2324
R=2328;2331;2335;2339;2342;2346;2350;2353;2357;2361
R=2365;2368;2372;2376;2380;2384;2388;2392;2395;2399
R=2403;2407;2411;2415;2419;2423;2427;2431;2435;2439
R=2443;2447;2452;2456;2460;2464;2468;2472;2476;2481
R=2485;2489;2493;2497;2502;2506;2510;2514;2519;2523
R=2527;2532;2536;2540;2545;2549;2553;2558;2562;2566
R=2571;2575;2580;2584;2589;2593;2597;2602;2606;2611
R=2615;2620;2624;2629;2633;2638;2642;2647;2651;2656
R=2661;2665;2670;2674;2679;2683;2688;2693;2697;2702
`;